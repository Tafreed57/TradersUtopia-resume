version: 1
frontend:
  phases:
    preBuild:
      commands:
        - nvm use 20
        - corepack enable
        - export NODE_OPTIONS="--max-old-space-size=14000"
        - rm -rf node_modules/.cache || true
        - rm -rf node_modules/@next || true
        - rm -rf node_modules/next || true
        - rm -rf .next || true
        - rm -rf .turbo || true
        - pnpm config set store-dir /tmp/pnpm-store
        - pnpm config set node-linker hoisted
        - pnpm config set shamefully-hoist true
        - pnpm i
    build:
      commands:
        - env | grep -e DATABASE_URL >> .env.production
        - env | grep -e STRIPE_SECRET_KEY >> .env.production
        - env | grep -e CLERK_SECRET_KEY >> .env.production
        - env | grep -e STRIPE_WEBHOOK_SECRET >> .env.production
        - env | grep -e NEXT_PUBLIC_STRIPE_CHECKOUT_URL >> .env.production
        - env | grep -e TRIGGER_SECRET_KEY >> .env.production
        - env | grep -e CLERK_WEBHOOK_SIGNING_SECRET >> .env.production
        - export AWS_APP_ID=d2z4m5288k2tz9
        - export AWS_BRANCH=$AWS_BRANCH
        - env | grep -e AWS_APP_ID >> .env.production
        - env | grep -e AWS_BRANCH >> .env.production
        - pnpm build
        - pnpm migrate:deploy
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
    # Exclude heavy files to reduce artifact size
    exclude:
      - node_modules/**/*
      - .git/**/*
      - '*.log'
      - docs/**/*
      - '.env*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
