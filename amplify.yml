version: 1
backend:
  phases:
    preBuild:
      commands:
        - sudo yum -y install jq
        - jq --version
        - npm i -g neonctl@v1
    build:
      commands:
        - nvm use 20
        - corepack enable
        - pnpm install
        - npx amplify pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
        # - bash neon-ci.sh create-branch --app-id $AWS_APP_ID --neon-project-id YOUR_NEON_PROJECT_ID --branch-name $AWS_BRANCH --parent-branch main --api-key-param "neon-api-key" --role-name neondb_owner --database-name neondb --suspend-timeout 0
        - |
          if [ -f .env ]; then
            echo "Found .env file, running Prisma migrations..."
            source .env && npx prisma migrate deploy
            source .env && npx prisma generate
          else
            echo "Warning: .env file not found, skipping Prisma migrations"
          fi

    postBuild:
      commands:
        - |
          # EXAMPLE: only run the cleanup-branches command if you have tested it
          if ! [ "${AWS_BRANCH}" = "main" ] && ! [ "${AWS_BRANCH}" = "dev" ]; then
            echo "Skipping branch cleanup for branch: ${AWS_BRANCH}"
            # bash neon-ci.sh cleanup-branches --app-id $AWS_APP_ID --neon-project-id YOUR_NEON_PROJECT_ID --api-key-param "neon-api-key"
          fi
  cache:
    paths:
      - $(pnpm store path)
frontend:
  phases:
    preBuild:
      commands:
        # Install dependencies
        - pnpm install --production=false
    build:
      commands:
        # Set production environment
        - echo "Building for production..."
        - echo .env
        - echo pwd
        - pnpm build
    postBuild:
      commands:
        # Optional: Clean up if needed
        - echo "Build completed successfully"
  artifacts:
    # For Next.js SSR apps, use .next directory
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
