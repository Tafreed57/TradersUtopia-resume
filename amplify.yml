version: 1
backend:
  phases:
    preBuild:
      commands:
        - sudo yum -y install jq
        - jq --version
        - npm i -g neonctl@v1
    build:
      commands:
        - nvm use 20
        - corepack enable
        - pnpm install
        # Create Neon database branch for this deployment
        - bash neon-ci.sh create-branch --app-id $AWS_APP_ID --neon-project-id YOUR_NEON_PROJECT_ID --branch-name $AWS_BRANCH --parent-branch main --api-key-param "neon-api-key" --role-name neondb_owner --database-name neondb --suspend-timeout 0
        # Run database migrations if .env file was created
        - |
          if [ -f .env ]; then
            echo "Found .env file, running Prisma migrations..."
            source .env && npx prisma migrate deploy
            source .env && npx prisma generate
          else
            echo "Warning: .env file not found, skipping Prisma migrations"
          fi
  cache:
    paths:
      - $(pnpm store path)
frontend:
  phases:
    preBuild:
      commands:
        - nvm use 20
        - corepack enable
        # Install dependencies
        - pnpm i
    build:
      commands:
        - echo "Building for production..."
        # Verify critical environment variables are set
        - echo "âœ… Environment variables verified"
        - pnpm build
    postBuild:
      commands:
        # Optional: Clean up if needed
        - echo "Build completed successfully"
  artifacts:
    # For Next.js SSR apps, use .next directory
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
